---
phase: 01-list-insights-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - frontend/src/hooks/insights/useListInsights.ts
  - frontend/src/hooks/insights/useMasterInsights.ts
  - frontend/src/hooks/insights/index.ts
autonomous: true
requirements: []

must_haves:
  truths:
    - "useListInsights(listId) fetches list data, enriches items with TMDB details and credits in parallel, and returns computed ListInsights"
    - "useMasterInsights() aggregates across all user lists and returns computed ListInsights"
    - "Both hooks use React Query with 5-minute stale time for caching"
    - "TMDB enrichment requests are batched with Promise.all for parallel fetching"
  artifacts:
    - path: "frontend/src/hooks/insights/useListInsights.ts"
      provides: "Per-list insights data hook"
      exports: ["useListInsights"]
    - path: "frontend/src/hooks/insights/useMasterInsights.ts"
      provides: "Master insights aggregating all lists"
      exports: ["useMasterInsights"]
    - path: "frontend/src/hooks/insights/index.ts"
      provides: "Barrel export for insight hooks"
      exports: ["useListInsights", "useMasterInsights"]
  key_links:
    - from: "frontend/src/hooks/insights/useListInsights.ts"
      to: "frontend/src/lib/insights/aggregators.ts"
      via: "calls aggregator functions with enriched items"
      pattern: "import.*from.*lib/insights/aggregators"
    - from: "frontend/src/hooks/insights/useListInsights.ts"
      to: "frontend/src/api/media.api.ts"
      via: "getMediaDetails for TMDB enrichment"
      pattern: "import.*getMediaDetails.*from.*api/media"
    - from: "frontend/src/hooks/insights/useListInsights.ts"
      to: "frontend/src/api/credit.api.ts"
      via: "getMediaCredits for cast/crew data"
      pattern: "import.*getMediaCredits.*from.*api/credit"
    - from: "frontend/src/hooks/insights/useMasterInsights.ts"
      to: "frontend/src/hooks/lists/useLists.ts"
      via: "useUserLists for all lists data"
      pattern: "import.*useUserLists.*from.*lists/useLists"
---

<objective>
Create the data-fetching hooks that fetch, enrich, and aggregate insights data for both per-list and master views.

Purpose: Bridge raw API data (lists, TMDB details, credits) with the aggregation layer. Hooks handle TMDB enrichment (parallel fetching of details + credits per item), call aggregator functions, and return typed ListInsights objects. React Query provides caching.

Output: useListInsights and useMasterInsights hooks with barrel export.
</objective>

<execution_context>
@/home/gustaffaivre/.claude/get-shit-done/workflows/execute-plan.md
@/home/gustaffaivre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-list-insights-dashboard/01-01-SUMMARY.md
@frontend/src/hooks/lists/useLists.ts
@frontend/src/hooks/lists/useMediaEntries.ts
@frontend/src/api/media.api.ts
@frontend/src/api/credit.api.ts
@frontend/src/types/insights.ts
@frontend/src/lib/insights/aggregators.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useListInsights hook for per-list insights</name>
  <files>
    frontend/src/hooks/insights/useListInsights.ts
  </files>
  <action>
Create `frontend/src/hooks/insights/useListInsights.ts`:

1. Import useQuery from @tanstack/react-query
2. Import useListById from ../lists/useLists
3. Import useMediaEntries from ../lists/useMediaEntries
4. Import getMediaDetails from ../../api/media.api
5. Import getMediaCredits from ../../api/credit.api
6. Import all aggregator functions from ../../lib/insights/aggregators
7. Import ListInsights type from ../../types/insights
8. Import MediaType from ../../types/tmdb

Define an async function `enrichListItems(items)` that:
- Takes ListItem[] and returns enriched items with TMDB details + credits
- Batch all getMediaDetails calls with Promise.allSettled (not Promise.all — graceful failure for individual items)
- Batch all getMediaCredits calls with Promise.allSettled
- MediaType cast: use `item.mediaType as MediaType` since ListItem stores "movie"|"tv" as string
- Merge results: for each item, attach details and credits from the parallel results
- Filter out items where enrichment completely failed (both details and credits rejected)
- Log warnings for individual failures but don't throw

Define `useListInsights(listId: number)`:
- Call useListById(listId) to get list data
- Call useMediaEntries() to get user's media entries (for rating comparison)
- Use useQuery with:
  - queryKey: ['insights', 'list', listId]
  - queryFn: enriches list.items, then calls all aggregator functions to build ListInsights object
  - enabled: Boolean(list?.items?.length) — only run if list has items
  - staleTime: 5 * 60 * 1000 (5 minutes)
  - The queryFn should:
    a. Call enrichListItems(list.items)
    b. Compute each metric: computeGenreDistribution, getTopGenres(5), computeTopActors(5), computeTopDirectors(5), computeRatingComparison (pass enriched items + mediaEntries), computeMostActiveMonth (pass list.items directly since addedAt is on ListItem), computeReleaseYearBreakdown
    c. Return complete ListInsights object with totalCount = list.items.length
- Also return isLoading from list query + insights query, and list name/metadata

Export: `useListInsights`
  </action>
  <verify>
    Run `cd frontend && npx tsc --noEmit` — no type errors.
  </verify>
  <done>
    useListInsights fetches list by ID, enriches items with TMDB details+credits in parallel batches, computes all 7 metrics via aggregator functions, returns typed ListInsights with React Query caching.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create useMasterInsights hook and barrel export</name>
  <files>
    frontend/src/hooks/insights/useMasterInsights.ts
    frontend/src/hooks/insights/index.ts
  </files>
  <action>
1. Create `frontend/src/hooks/insights/useMasterInsights.ts`:

- Import useQuery from @tanstack/react-query
- Import useUserLists from ../lists/useLists
- Import useMediaEntries from ../lists/useMediaEntries
- Import getMediaDetails, getMediaCredits
- Import all aggregator functions
- Import types

Define `useMasterInsights()`:
- Call useUserLists() to get all lists
- Call useMediaEntries() to get user's media entries
- Flatten all list items across all lists into a single array
- Deduplicate by tmdbId+mediaType (same media in multiple lists should count once)
- Use useQuery with:
  - queryKey: ['insights', 'master']
  - queryFn: enriches deduplicated items, computes all metrics, returns ListInsights
  - enabled: Boolean(allItems.length)
  - staleTime: 5 * 60 * 1000
  - Same enrichment + aggregation pattern as useListInsights
- Return: insights data, isLoading, totalListCount

Export: `useMasterInsights`

2. Create `frontend/src/hooks/insights/index.ts`:
- Barrel export: `export { useListInsights } from './useListInsights'`
- Barrel export: `export { useMasterInsights } from './useMasterInsights'`
  </action>
  <verify>
    Run `cd frontend && npx tsc --noEmit` — no type errors. Both hooks are importable from the barrel.
  </verify>
  <done>
    useMasterInsights aggregates all lists into unified insights with deduplication. Barrel export provides clean import path. Both hooks share enrichment and aggregation patterns.
  </done>
</task>

</tasks>

<verification>
- `cd frontend && npx tsc --noEmit` passes with zero errors
- useListInsights accepts listId and returns { data: ListInsights, isLoading, ... }
- useMasterInsights returns { data: ListInsights, isLoading, ... }
- Both hooks import and use aggregator functions correctly
- Both use Promise.allSettled for graceful TMDB enrichment
- Both use React Query with 5-min stale time
</verification>

<success_criteria>
- Per-list insights hook fetches, enriches, and aggregates data for a single list
- Master insights hook deduplicates and aggregates across all lists
- TMDB enrichment batched with Promise.allSettled (no waterfall, graceful failures)
- React Query caching with 5-minute stale time
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-list-insights-dashboard/01-03-SUMMARY.md`
</output>
