---
phase: 01-list-insights-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/types/insights.ts
  - frontend/src/lib/insights/aggregators.ts
  - frontend/src/lib/insights/formatters.ts
  - frontend/src/components/insights/charts/DonutChart.tsx
  - frontend/src/components/insights/charts/BarChart.tsx
  - frontend/package.json
autonomous: true
requirements: []

must_haves:
  truths:
    - "Insight types define all aggregated metric shapes (genre distribution, top people, rating comparison, active month, release year)"
    - "Pure aggregator functions correctly compute genre distribution, top actors, top directors, rating comparison, most active month, and release year breakdown from raw list/media data"
    - "Recharts donut and bar chart wrapper components render with Cinelas blizzard theme colors and tooltip styling"
  artifacts:
    - path: "frontend/src/types/insights.ts"
      provides: "TypeScript interfaces for all insight metrics"
      contains: "GenreDistribution"
    - path: "frontend/src/lib/insights/aggregators.ts"
      provides: "Pure aggregation functions for all 6 metrics"
      exports: ["computeGenreDistribution", "computeTopActors", "computeTopDirectors", "computeRatingComparison", "computeMostActiveMonth", "computeReleaseYearBreakdown"]
    - path: "frontend/src/lib/insights/formatters.ts"
      provides: "Display formatting utilities"
      exports: ["formatCount", "formatPercentage", "formatRating"]
    - path: "frontend/src/components/insights/charts/DonutChart.tsx"
      provides: "Recharts donut chart with theme colors and tooltips"
      exports: ["default"]
    - path: "frontend/src/components/insights/charts/BarChart.tsx"
      provides: "Recharts bar chart with theme colors and tooltips"
      exports: ["default"]
  key_links:
    - from: "frontend/src/lib/insights/aggregators.ts"
      to: "frontend/src/types/insights.ts"
      via: "imports insight type interfaces"
      pattern: "import.*from.*types/insights"
    - from: "frontend/src/components/insights/charts/DonutChart.tsx"
      to: "recharts"
      via: "PieChart, Pie, Cell, ResponsiveContainer, Tooltip"
      pattern: "import.*from.*recharts"
---

<objective>
Create the data foundation and chart primitives for the insights dashboard.

Purpose: Establish TypeScript types for all insight metrics, implement pure aggregation functions that transform raw list/media data into dashboard-ready metrics, and create reusable Recharts chart wrapper components styled to the Cinelas blizzard theme.

Output: Types, aggregator functions, formatter utilities, DonutChart and BarChart components. Recharts installed as dependency.
</objective>

<execution_context>
@/home/gustaffaivre/.claude/get-shit-done/workflows/execute-plan.md
@/home/gustaffaivre/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@frontend/src/types/list.ts
@frontend/src/types/mediaEntry.ts
@frontend/src/types/tmdb.ts
@frontend/src/api/credit.api.ts
@frontend/src/api/media.api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Recharts, create insight types, and implement aggregation functions</name>
  <files>
    frontend/package.json
    frontend/src/types/insights.ts
    frontend/src/lib/insights/aggregators.ts
    frontend/src/lib/insights/formatters.ts
  </files>
  <action>
1. Install recharts: `cd frontend && npm install recharts`

2. Create `frontend/src/types/insights.ts` with these interfaces:
   - `GenreDistribution { name: string; value: number; percentage: number }`
   - `TopPerson { id: number; name: string; profilePath: string | null; count: number; roles: Array<{ title: string; character?: string; job?: string }> }`
   - `RatingComparison { userAverage: number; tmdbAverage: number; difference: number; itemCount: number }`
   - `ActiveMonth { monthKey: string; year: number; count: number; displayName: string }`
   - `ReleaseYearBreakdown { year: number; decade: string; count: number }` (for release year/decade viz — using bar chart per Claude's discretion)
   - `ListInsights { totalCount: number; genreDistribution: GenreDistribution[]; topGenres: GenreDistribution[]; topActors: TopPerson[]; topDirectors: TopPerson[]; ratingComparison: RatingComparison; mostActiveMonth: ActiveMonth | null; releaseYearBreakdown: ReleaseYearBreakdown[] }`
   - Import existing types from `../types/list` (ListItem) and `../types/tmdb` (DetailMedia, Credit, CreditsResponse) as needed

3. Create `frontend/src/lib/insights/aggregators.ts` with pure functions:
   - `computeGenreDistribution(items)` — count genres from DetailMedia.genres (optional chain safely), return sorted GenreDistribution[]
   - `getTopGenres(distribution, limit=5)` — slice top N from distribution
   - `computeTopActors(items, limit=5)` — count cast appearances (top 5 cast per media to avoid extras), return sorted TopPerson[]
   - `computeTopDirectors(items, limit=5)` — filter crew by job==='Director', count appearances, return sorted TopPerson[]
   - `computeRatingComparison(items, mediaEntries)` — compute user average from MediaEntry ratings (average of ratingActing, ratingStory, ratingVisuals, ratingSoundtrack where non-null), compute TMDB average from DetailMedia.vote_average. Join on tmdbId+mediaType. Items without matching MediaEntry use TMDB rating for both.
   - `computeMostActiveMonth(items)` — group by addedAt month/year (use addedAt since it's always present on ListItem, unlike watchedAt), return month with highest count. Use native Date + Intl.DateTimeFormat for display name.
   - `computeReleaseYearBreakdown(items)` — extract year from releaseDate (movies) or firstAirDate (TV), group by decade (2020s, 2010s, etc.), return sorted ReleaseYearBreakdown[]
   - All functions must use defensive optional chaining. Filter out items with missing/null data before aggregating.
   - Define the enriched item type inline: `EnrichedListItem = ListItem & { details?: DetailMedia; credits?: CreditsResponse }`

4. Create `frontend/src/lib/insights/formatters.ts`:
   - `formatCount(n: number): string` — e.g., 1234 -> "1,234"
   - `formatPercentage(n: number, decimals=0): string` — e.g., 45.6 -> "46%"
   - `formatRating(n: number): string` — e.g., 7.345 -> "7.3"
   - `formatDecade(year: number): string` — e.g., 2023 -> "2020s"
  </action>
  <verify>
    Run `cd frontend && npx tsc --noEmit` — no type errors in new files. Verify recharts appears in package.json dependencies.
  </verify>
  <done>
    All insight type interfaces exported. All 7 aggregator functions exported and type-safe. All 4 formatter functions exported. Recharts installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create reusable Recharts chart wrapper components</name>
  <files>
    frontend/src/components/insights/charts/DonutChart.tsx
    frontend/src/components/insights/charts/BarChart.tsx
  </files>
  <action>
1. Create `frontend/src/components/insights/charts/DonutChart.tsx`:
   - Import PieChart, Pie, Cell, ResponsiveContainer, Tooltip, Legend from recharts
   - Props: `data: Array<{ name: string; value: number }>`, optional `colors: string[]`, optional `height: number` (default 280)
   - Default colors array using Cinelas blizzard theme HSL values:
     - `hsl(197, 100%, 50%)` (accent-primary)
     - `hsl(215, 99%, 58%)` (accent-secondary)
     - `hsl(228, 85%, 62%)` (accent-thirdary)
     - `hsl(207, 92%, 36%)` (secondary)
     - `hsl(199, 100%, 45%)` (primary)
     - Add 3-4 more muted tones for genres beyond 5
   - Donut config: innerRadius={55}, outerRadius={90}, paddingAngle={2}
   - Tooltip with dark theme styling: backgroundColor `hsl(222, 38%, 14%)`, border `hsl(240, 1%, 24%)`, text white, borderRadius 8px
   - Legend with white text, positioned bottom
   - Wrap in ResponsiveContainer width="100%"
   - Handle empty data gracefully (return null or empty message)

2. Create `frontend/src/components/insights/charts/BarChart.tsx`:
   - Import BarChart as RechartsBarChart, Bar, XAxis, YAxis, ResponsiveContainer, Tooltip, CartesianGrid from recharts
   - Props: `data: Array<{ label: string; value: number }>`, optional `color: string` (default accent-primary HSL), optional `height: number` (default 280)
   - This will be used for Release Year/Decade visualization (bar chart per Claude's discretion — bar chart clearly shows distribution across time periods)
   - XAxis dataKey="label", YAxis with integer ticks, CartesianGrid with subtle dashed lines (stroke hsl(240, 1%, 24%), strokeDasharray="3 3")
   - Same dark tooltip styling as DonutChart
   - Bar with rounded top corners (radius={[4, 4, 0, 0]})
   - Handle empty data gracefully
  </action>
  <verify>
    Run `cd frontend && npx tsc --noEmit` — no type errors. Both components compile successfully.
  </verify>
  <done>
    DonutChart renders Recharts PieChart with blizzard theme colors and dark tooltips. BarChart renders Recharts BarChart with theme styling. Both handle empty data. Both use ResponsiveContainer for responsive sizing.
  </done>
</task>

</tasks>

<verification>
- `cd frontend && npx tsc --noEmit` passes with zero errors
- `recharts` appears in frontend/package.json dependencies
- All type interfaces in insights.ts are importable
- All aggregator functions are importable and have correct return types
- Chart components compile and accept their typed props
</verification>

<success_criteria>
- Recharts installed and importable
- 6+ pure aggregator functions computing all required metrics (genre distribution, top genres, top actors, top directors, rating comparison, most active month, release year breakdown)
- DonutChart and BarChart wrappers styled to blizzard theme with dark tooltips
- Zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-list-insights-dashboard/01-01-SUMMARY.md`
</output>
